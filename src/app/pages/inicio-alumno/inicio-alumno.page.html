<!-- HEADER PERSONALIZADO -->
<div class="header-custom">
  <span class="student-name">{{ nombreCompleto }}</span>
  <span class="student-group">{{ grupoNombre }}</span>
</div>

<ion-content>
  <div class="content-container">

    <!-- 0. SECCIÓN: RECOMENDACIÓN IA (NUEVO) -->
    <div class="ai-recommendation-card" *ngIf="atencionPrioritaria">
      <div class="ai-icon-container">
        <ion-icon name="alert-circle" class="pulse-icon"></ion-icon>
      </div>
      <div class="ai-content">
        <h3>Atención Prioritaria</h3>
        <p class="subject-highlight">{{ atencionPrioritaria.nombre }}</p>
        <p class="reason-text">
          Se detectó un <strong>{{ atencionPrioritaria.probabilidad }}%</strong> de riesgo de reprobación.
          <br>
          <small>Motivo: {{ atencionPrioritaria.motivo }}</small>
        </p>
      </div>
    </div>

    <!-- 1. SECCIÓN: SOLICITUD DE ASISTENCIA -->
    <h2>Enviar solicitud de asistencia</h2>

    <div class="subjects-list">
      
      <div *ngFor="let materia of materias">
        
        <!-- ESTADO 1: YA ENVIADA (Azul) -->
        <button class="subject-card success" 
                *ngIf="materia.estado_solicitud === 'Pendiente' || materia.estado_solicitud === 'Aceptada'">
          <span class="subject-name">{{ materia.nombre_materia }}</span>
          <ion-icon name="checkmark-circle" class="status-icon"></ion-icon>
        </button>

        <!-- ESTADO 2: DISPONIBLE PARA ENVIAR (Naranja) -->
        <button class="subject-card active" 
                *ngIf="!materia.estado_solicitud && materia.puede_solicitar"
                (click)="enviarSolicitud(materia.clase_id)">
          <span class="subject-name">{{ materia.nombre_materia }}</span>
        </button>

        <!-- ESTADO 3: NO DISPONIBLE (Gris) -->
        <div class="subject-card disabled" 
             *ngIf="!materia.estado_solicitud && !materia.puede_solicitar">
          <span class="subject-name">{{ materia.nombre_materia }}</span>
          <span class="status-text">No disponible</span>
        </div>

      </div>

      <!-- Spinner si está cargando -->
      <div *ngIf="loading" style="text-align:center; padding: 20px;">
        <ion-spinner color="primary"></ion-spinner>
      </div>

    </div>

    <p class="helper-text">Solo puedes solicitar asistencia en el horario de clase.</p>


    <!-- 2. SECCIÓN: RESUMEN DE FALTAS -->
    <h2>Resumen de faltas:</h2>
    
    <div class="summary-card">
      <div class="fault-row" *ngFor="let item of asistenciasResumen">
        <span class="fault-count" [ngClass]="item.total_faltas > 0 ? 'danger' : 'safe'">
          {{ item.total_faltas }}
        </span>
        <span class="fault-materia">{{ item.materia }}</span>
      </div>
      
      <p *ngIf="asistenciasResumen.length === 0 && !loading" style="text-align:center; color:#888;">
        Sin historial de asistencia.
      </p>
    </div>


    <!-- 3. SECCIÓN: PROMEDIO GENERAL -->
    <h2>Promedio General</h2>
    
    <div class="average-section" *ngIf="promedioGeneral > 0">
      <!-- Círculo de Progreso -->
      <div class="circle-progress" [style.background]="'conic-gradient(#9fc34c ' + (promedioGeneral * 10) + '%, #e0e0e0 0)'">
        <span class="grade-number">{{ promedioGeneral | number:'1.1-1' }}</span>
      </div>

      <!-- Lista de Calificaciones -->
      <div class="grades-list">
        <div class="grade-row" *ngFor="let calif of calificacionesDetalle">
          <span class="grade-name">{{ calif.nombre }}</span>
          <span class="grade-val" [ngClass]="{
            'high': calif.calificacion >= 9, 
            'med': calif.calificacion >= 8 && calif.calificacion < 9,
            'low': calif.calificacion < 8
          }">
            {{ calif.calificacion }}
          </span>
        </div>
      </div>
    </div>

  </div>
</ion-content>